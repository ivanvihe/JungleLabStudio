Testing with improved error handling